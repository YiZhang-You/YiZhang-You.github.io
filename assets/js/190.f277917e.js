(window.webpackJsonp=window.webpackJsonp||[]).push([[190],{919:function(s,e,a){"use strict";a.r(e);var n=a(4),r=Object(n.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"_1-上传数据的存储"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-上传数据的存储"}},[s._v("#")]),s._v(" "),e("strong",[s._v("1. 上传数据的存储")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("在保存上传的文件之前，数据需要保存到某处。\n\n默认情况下，如果上传的文件小于2.5兆，Django 将把文件的所有内容保存到内存里。这意味着保存文件只涉及从内存中读取和写入磁盘，因此这很快。\n\n但如果上传的文件很大，Django 会把文件写入系统临时目录的临时文件里存储。在类 Unix 平台里这意味着 Django 会生成一个类似名为 `/tmp/tmpzfp6I6.upload` 的文件。如果上传的文件非常大，你可以查看这个文件的大小增长，因为 Django 将数据流式传输到磁盘上\n\nDjango 处理文件上传时, 文件最终会位于 `request.FILES`\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h2",{attrs:{id:"_2-简单文件上传"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-简单文件上传"}},[s._v("#")]),s._v(" "),e("strong",[s._v("2. 简单文件上传")])]),s._v(" "),e("p",[s._v("考虑一个包含 "),e("code",[s._v("FileField")]),s._v(" 的表单：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django import forms\n\nclass UploadFile(forms.Form):\n    file = forms.FileField()\n处理这个表单的视图将通过:attr:request.FILES获取到文件数据,\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("strong",[s._v("注意")])]),s._v(" "),e("p",[s._v("只有在请求是通过 "),e("code",[s._v("POST")]),s._v(" 提交且提交的 "),e("code",[s._v("<form>")]),s._v(" 表单有 "),e("code",[s._v('enctype="multipart/form-data"')]),s._v(" 属性的时候，"),e("code",[s._v("request.FILES")]),s._v("才会包含文件数据，否则的话， "),e("code",[s._v("request.FILES")]),s._v(" 是空的。")]),s._v(" "),e("p",[s._v("大多数情况下，你需要像这样将文件数据从 "),e("code",[s._v("request")]),s._v(" 传递给表单。示例如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django.http import HttpResponseRedirect\nfrom django.shortcuts import render\nfrom .forms import UploadFileForm\n\nfrom somewhere import handle_uploaded_file\n\ndef upload_file(request):\n    if request.method == 'POST':\n        form = UploadFile(request.POST, request.FILES)\n        if form.is_valid():\n            handle_uploaded_file(request.FILES['file'])\n            return HttpResponseRedirect('')\n    else:  # GET\n        form = UploadFile()\n    return render(request, 'test.html', {'form': form})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("注意我们必须将 "),e("code",[s._v("request.FILES")]),s._v("传入到表单的 构造方法中，只有这样文件数据才能绑定到表单中。")]),s._v(" "),e("h2",{attrs:{id:"_3-通过模型来处理上传的文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-通过模型来处理上传的文件"}},[s._v("#")]),s._v(" "),e("strong",[s._v("3. 通过模型来处理上传的文件")])]),s._v(" "),e("p",[s._v("如果想要在 "),e("code",[s._v("FileField")]),s._v(" 上的 "),e("code",[s._v("Model")]),s._v("保存文件，使用 "),e("code",[s._v("ModelForm")]),s._v("会让这一过程变得简单。当调用 "),e("code",[s._v("form.save()")]),s._v(" 时，文件对象将会被保存在对相应 "),e("code",[s._v("FileField")]),s._v(" 的 "),e("code",[s._v("upload_to")]),s._v("参数所指定的地方：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django.http import HttpResponseRedirect\nfrom django.shortcuts import render\nfrom .forms import ModelFormWithFileField\n\ndef upload_file(request):\n    if request.method == 'POST':\n        form = ModelFormWithFileField(request.POST, request.FILES)\n        if form.is_valid():\n            form.save()\n            return HttpResponseRedirect('')\n    else:\n        form = ModelFormWithFileField()\n    return render(request, 'test.html', {'form': form})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("如果你准备手工构建对象，你可以指定来自 "),e("code",[s._v("request.FILES")]),s._v(") 的文件对象到模型里的文件对象：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django.http import HttpResponseRedirect\nfrom django.shortcuts import render\nfrom .forms import UploadFileForm\nfrom .models import ModelWithFileField\n\ndef upload_file(request):\n    if request.method == 'POST':\n        form = UploadFileForm(request.POST, request.FILES)\n        if form.is_valid():\n            instance = ModelWithFileField(file_field=request.FILES['file'])\n            instance.save()\n            return HttpResponseRedirect('/success/url/')\n    else:\n        form = UploadFileForm()\n    return render(request, 'upload.html', {'form': form})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h2",{attrs:{id:"_4-上传多个文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-上传多个文件"}},[s._v("#")]),s._v(" "),e("strong",[s._v("4. 上传多个文件")])]),s._v(" "),e("p",[s._v("如果你想使用一个表单字段上传多个文件，则需要设置字段的 widget 的 "),e("code",[s._v("multiple=True")]),s._v(" HTML 属性。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django import forms\n\nclass FileFieldForm(forms.Form):\n    file_field = forms.FileField(widget=forms.ClearableFileInput(attrs={'multiple': True}))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("然后覆盖 FormView子类的 "),e("code",[s._v("post")]),s._v(" 方法来控制多个文件上传：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django.views.generic.edit import FormView\nfrom .forms import FileFieldForm\n\nclass FileFieldView(FormView):\n    form_class = FileField\n    template_name = 'test.html'\n    success_url = '...'\n\n    def post(self, request, *args, **kwargs):\n        form_class = self.get_form_class()\n        form = self.get_form(form_class)\n        files = request.FILES.getlist('file_field')\n        if form.is_valid():\n            for f in files:\n                pass\n            return self.form_valid(form)\n        else:\n            return self.form_invalid(form)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h2",{attrs:{id:"_5-上传-handlers"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-上传-handlers"}},[s._v("#")]),s._v(" "),e("strong",[s._v("5. 上传 Handlers")])]),s._v(" "),e("p",[s._v("当一个用户上传文件时，Django 会把文件数据传递给 "),e("em",[s._v("upload handler")]),s._v(" —— 这是一个很小的类，它用来在上传时处理文件数据。上传处理模块最初定义在 "),e("code",[s._v("FILE_UPLOAD_HANDLERS")]),s._v("里，默认为：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('["django.core.files.uploadhandler.MemoryFileUploadHandler",\n "django.core.files.uploadhandler.TemporaryFileUploadHandler"]\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("实例")]),s._v(" "),e("p",[e("code",[s._v("MemoryFileUploadHandler")]),s._v("和 "),e("code",[s._v("TemporaryFileUploadHandler")]),s._v(" 提供 Django 默认文件上传行为，小文件读入内存，大文件存在磁盘上。")]),s._v(" "),e("p",[s._v("你只能在访问 "),e("code",[s._v("request.POST")]),s._v(" 或 "),e("code",[s._v("request.FILES")]),s._v(" 之前修改上传处理程序，开始上传处理后修改上传处理程序没有意义。如果你从读取 "),e("code",[s._v("request.POST")]),s._v(" 或 "),e("code",[s._v("request.FILES")]),s._v(" 之后尝试修改 "),e("code",[s._v("request.upload_handlers")]),s._v(" ，Django 会报错。")]),s._v(" "),e("p",[s._v("因此，你要尽早在视图里修改上传处理程序。")]),s._v(" "),e("p",[s._v("而且， "),e("code",[s._v("request.POST")]),s._v(" 由 "),e("code",[s._v("CsrfViewMiddleware")]),s._v(" 访问，默认情况下已开启。这意味着你需要在视图上使用 "),e("code",[s._v("csrf_exempt()")]),s._v(" 来允许你改变上传处理程序。然后你需要在实际处理请求的函数上使用 "),e("code",[s._v("csrf_protect()")]),s._v("。注意这可能会让处理程序在 CSRF 检测完成之前开始接受文件上传。示例：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("from django.views.decorators.csrf import csrf_exempt, csrf_protect\n\n@csrf_exempt\ndef upload_file_view(request):\n    request.upload_handlers.insert(0, ProgressBarUploadHandler(request))\n    return _upload_file_view(request)\n\n@csrf_protect\ndef _upload_file_view(request):\n    pass\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("1")])])}),[],!1,null,null,null);e.default=r.exports}}]);