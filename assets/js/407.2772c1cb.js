(window.webpackJsonp=window.webpackJsonp||[]).push([[407],{1198:function(s,a,n){"use strict";n.r(a);var e=n(4),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"redis数据持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis数据持久化"}},[s._v("#")]),s._v(" "),a("strong",[s._v("redis数据持久化")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/pyyu/p/10009493.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/pyyu/p/10009493.html"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("code",[s._v("Redis")]),s._v("是一种内存型数据库，一旦服务器进程退出，数据库的数据就会丢失，为了解决这个问题，"),a("code",[s._v("Redis")]),s._v("提供了两种持久化的方案，将内存中的数据保存到磁盘中，避免数据的丢失。")]),s._v(" "),a("p",[a("strong",[s._v("！就想我本来redis中有很多数据，突然服务器挂了，或者使用pkill等一些杀掉对应的redis进程，在重启的时候数据一个都没有（所有一定要做持久化）")])]),s._v(" "),a("h4",{attrs:{id:"rdb持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rdb持久化"}},[s._v("#")]),s._v(" "),a("strong",[s._v("RDB持久化")])]),s._v(" "),a("p",[a("code",[s._v("redis")]),s._v("提供了"),a("code",[s._v("RDB持久化")]),s._v("的功能，这个功能可以将"),a("code",[s._v("redis")]),s._v("在内存中的的状态保存到硬盘中，它可以手动执行。")]),s._v(" "),a("p",[s._v("也可以再"),a("code",[s._v("redis.conf")]),s._v("中配置，定期执行。")]),s._v(" "),a("p",[s._v("RDB持久化产生的RDB文件是一个经过压缩的二进制文件，这个文件被保存在硬盘中，redis可以通过这个文件还原数据库当时的状态。")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("RDB(持久化)\n内存数据保存到磁盘\n在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）\n优点：速度快，适合做备份，主从复制就是基于RDB持久化功能实现\nrdb通过再redis中使用save命令触发 rdb\n\nrdb配置参数：\n\ndir /data/6379/  # 日志存放路径\ndbfilename  dbmp.rdb  # 数据存放名称\n\n# 每过900秒 有1个操作就进行持久化\nsave  900 1  # 900秒  1个修改类的操作\nsave 300 10  # 300秒  10个操作\nsave 60  10000  # 60秒  10000个操作\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[a("strong",[s._v("redis持久化之RDB实践")])]),s._v(" "),a("p",[s._v("我们在启动redis-server服务端的时候，我们可以写一个自己的配置，redis-server 自定义配置名称 一起启动。这样就可以进行修改")]),s._v(" "),a("p",[s._v("1、准备配置文件")]),s._v(" "),a("p",[s._v("my_redis.conf")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("daemonize yes\nport 6379\nlogfile /data/6379/redis.log  # 日志\ndir /data/6379              #定义持久化文件存储位置\ndbfilename  dbmp.rdb        #rdb持久化文件\nbind 127.0.0.1    #redis绑定地址\nrequirepass 123456            #redis登录密码\nsave 900 1                    #rdb机制 每900秒 有1个修改记录\nsave 300 10                    #每300秒        10个修改记录\nsave 60  10000                #每60秒内        10000修改记录\n\n# 1、mkdir -p /data/6379 没有这个文件夹要先创建\n# 2、写配置脚本的时候，不要这些注释\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("2、写好脚本my_redis.conf,启动redis服务端")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("redis-server my_redis.conf  # 在脚本目录下\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3、启动客户端")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("redis-cli -a 123456\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4、此时检查目录，/data/6379底下没有dbmp.rdb文件")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("还没有数据，所有就只有创建的redis.log\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("5、通过save触发持久化，将数据写入RDB文件")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> save\nOK\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("这个时候，我在干掉redis进程，然后重启发现数据还在。")])]),s._v(" "),a("p",[a("strong",[s._v("注意：rdb缺点，可能会造成数据的丢失但是持久化速度最快")])]),s._v(" "),a("h4",{attrs:{id:"aof持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aof持久化"}},[s._v("#")]),s._v(" "),a("strong",[s._v("AOF持久化")])]),s._v(" "),a("p",[s._v("AOF（append-only log file）\n记录服务器执行的所有变更操作命令（例如set del等），并在服务器启动时，通过重新执行这些命令来还原数据集\nAOF 文件中的命令全部以redis协议的格式保存，新命令追加到文件末尾。\n优点：最大程序保证数据不丢\n缺点：日志记录非常大")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("redis-client   写入数据  >  redis-server   同步命令   >  AOF文件\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("配置参数")])]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("AOF持久化配置，两条参数\n\nappendonly   yes\nappendfsync  always    总是修改类的操作\n             everysec   每秒做一次持久化\n             no     依赖于系统自带的缓存大小机制\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("strong",[s._v("redis持久化之AOF实践")])]),s._v(" "),a("p",[s._v("1、准备配置文件")]),s._v(" "),a("p",[s._v("my_redis.conf")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("daemonize yes\nport 6379\nlogfile /data/6379/redis.log  # 日志\ndir /data/6379              #定义持久化文件存储位置\ndbfilename  dbmp.rdb        #rdb持久化文件\nbind 127.0.0.1    #redis绑定地址\nrequirepass 123456            #redis登录密码\nsave 900 1                    #rdb机制 每900秒 有1个修改记录\nsave 300 10                    #每300秒        10个修改记录\nsave 60  10000                #每60秒内        10000修改记录\n\nappendonly yes\t# AOF\nappendfsync always\n\n# 1、mkdir -p /data/6379 没有这个文件夹要先创建\n# 2、写配置脚本的时候，不要这些注释\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("2、写好脚本my_redis.conf,启动redis服务端")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("redis-server my_redis.conf  # 在脚本目录下\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3、启动客户端")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("redis-cli -a 123456\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4、检查redis数据目录/data/6379/是否产生了aof文件")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@web02 6379]# ls\nappendonly.aof  dbmp.rdb  redis.log\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("5、实时检查aof文件信息")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@web02 6379]# tail -f appendonly.aof\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("6、设置新key，检查aof信息，然后关闭redis，检查数据是否持久化")]),s._v(" "),a("p",[a("strong",[s._v("redis 持久化方式有哪些？有什么区别？")])]),s._v(" "),a("p",[a("strong",[s._v("rdb：基于快照的持久化，速度更快，一般用作备份，主从复制也是依赖于rdb持久化功能")])]),s._v(" "),a("p",[a("strong",[s._v("aof：以追加的方式记录redis操作日志的文件。可以最大程度的保证redis数据安全，类似于mysql的binlog")])]),s._v(" "),a("h4",{attrs:{id:"redis不重启-切换rdb备份到aof备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis不重启-切换rdb备份到aof备份"}},[s._v("#")]),s._v(" "),a("strong",[s._v("redis不重启，切换RDB备份到AOF备份")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/pyyu/p/10061526.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/pyyu/p/10061526.html"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("确保redis版本在2.2以上，redis-server -v 查看版本")])]),s._v(" "),a("p",[s._v("我现在是RDB备份，登录redis-cli插入数据，手动持久化")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("127.0.0.1:6379> set name chaoge\nOK\n127.0.0.1:6379> save\nOK\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("检查RDB文件，这个时间就会生成dbmp.rdb文件")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@pyyuc /data 22:34:16]#ls 6379/\ndbmp.rdb  redis.log\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("1、备份这个rdb文件，保证数据的安全")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@pyyuc /data/6379 22:35:38]#cp dbmp.rdb dbmp.rdb.bak\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2、执行命令，开启AOF持久化")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('127.0.0.1:6379> CONFIG set appendonly yes   #开启AOF功能\nOK\n127.0.0.1:6379> CONFIG SET save ""  #关闭RDB功能\nOK\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("3、这样我们就可以在文件夹下会出来一个新的AOF的记录文件")]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("appendonly.aof\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("此时RDB已经正确切换AOF，注意还得修改my_redis.conf添加AOF设置，不然重启后，通过config set的配置将丢失.")])]),s._v(" "),a("div",{staticClass:"language-Plain Text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("重启后添加配置脚本添加\n# vim my_nginx.conf\nappendonly   yes\nappendfsync  always\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:""}},[a("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])])])}),[],!1,null,null,null);a.default=r.exports}}]);